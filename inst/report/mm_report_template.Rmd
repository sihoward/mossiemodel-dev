---
output:
  html_document: default
  pdf_document: default
  word_document: default
fontsize: 10pt
geometry: margin=0.5in
urlcolor: blue
editor_options:
  chunk_output_type: console
params:
  res: null
  plasmod_devel_seq: null
---

<!-- [![](images/MW_LR_Landscape_lge_blk-01.png){width="200"}](https://www.landcareresearch.co.nz/)   -->

```{r MWLR logo, echo=FALSE, fig.align='right', out.width='2in'}
knitr::include_graphics(system.file("app/www/MW_LR_Landscape_lge_blk.png", package = "mosqmod"))
```

# MossieModel Results Report

[Chris Niebuhr](https://www.landcareresearch.co.nz/about-us/our-people/chris-niebuhr){target="_blank"}\*, [Simon Howard](https://www.landcareresearch.co.nz/about-us/our-people/simon-howard){target="_blank"}\*

**\* Manaaki Whenua --- Landcare Research**

*Report generated using* [landcare.shinyapps.io/MossieModel](https://landcare.shinyapps.io/MossieModel/){target="_blank"} *on `r format(Sys.Date(), '%e %B, %Y')`*

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(knitr.kable.NA = '')
```

```{r get results, message=FALSE, warning=FALSE, include=FALSE}

# result object specified in params argument to rmarkdown::render()
res <- params$res
plasmod_devel_seq <- params$plasmod_devel_seq


# if params argument to rmarkdown::render() is null run model example and use
# resulting res object
if(is.null(params$res)) example("runModel", package = "mosqmod")

```

```{r get example results, message=FALSE, warning=FALSE, include=FALSE, results=FALSE}

# run this chunk to get dummy inputs when running troubleshooting/developing the markdown document
# set the 'eval' chunk option back to FALSE when finished

library(mosqmod)
example("runModel")

# set species attribute in results object 
# (this is typically set using the species drop-down UI in the app)
attr(res, "species") <- "Culex pervigilans"

# get full temperature sequence used in runModel output
temp_seq <- attributes(res)$temp_seq

cal_degday_means <- getCalendarDegreeDays(subset(temp_seq, !source %in% "projected"), 
                                                 developtemp = 12.97, timeout = 30L)
plasmod_devel_seq <- 
  plasmod_devel(temp_seq = subset(temp_seq, !source %in% "projected" & Date %in% res$Date),
              cal_degday_means = cal_degday_means,
              extend_days = 90L)

```

### Model parameters

```{r format parameters, echo=FALSE, message=FALSE, warning=FALSE}

# general info

ClimateStation <- unique(res$Station[!is.na(res$Station)])
ClimateStationID <- clifro::cf_find_station(ClimateStation, search = "name")[["agent"]]
  # lookup user-friendly site names using station names
SiteName <- c("Dunedin, Musselburgh Ews" = "Dunedin", "Nugget Point Aws" = "Catlins")[ClimateStation]

# combine general info into data.frame

general_info <- 
    data.frame(Type = "General", 
             Description = c("Site name", 
                             "Climate station",
                             "Mosquito species",
                             "Model version",
                             "Model timestamp"),
             Value = c(SiteName, 
                       paste0(ClimateStation, " (ID:", ClimateStationID, ")"),
                       paste0("*", attr(res, "species"), "*"),
                       as.character(attr(res, "mosqmod_ver")),
                       format(attr(res, "TimeStamp"), "%Y-%m-%d %H:%M %Z")))
general_info$Type[-1] <- NA

# format model parameters
mosq_params <- attr(res, "params")
mosq_params <- data.frame(Value = mosq_params)

## store parameter descriptions
param_descript <- 
  c(b = "Number of female eggs per clutch", 
    alpha = "Daily adult mortality rate", 
    beta = "Daily larval mortality rate", 
    K_L = "Larval carrying capacity (numbers/km^2)", 
    M_max = "Maximum adult density (numbers/km^2)", 
    MTD = "Minimum temperature for mosquito development (MTD)", 
    L_1 = "Starting density of first instar larvae", 
    L_2 = "Starting density of second instar larvae",
    L_3 = "Starting density of third instar larvae",
    L_4 = "Starting density of fourth instar larvae",
    L_5 = "Starting density of fifth instar larvae",
    M = "Starting density of adults",
    Mfloor = "Mfloor")

## assign descriptions and format parameter table
mosq_params$Description <- param_descript[row.names(mosq_params)]
mosq_params$Value <- format(mosq_params$Value, digits = 1, nsmall = 3, 
                             scientific = FALSE, drop0trailing = TRUE)
mosq_params$Type <- "Mosquito parameters"

# separate tables into front page and appendix
mosq_params_front <- mosq_params[6,]
mosq_params_appendix <- mosq_params[-6,]
mosq_params_front$Type[-1] <- mosq_params_appendix$Type[-1] <- NA

# plasmodium parameters

plasmod_params_front <- 
  data.frame(Type = "Plasmodium parameters", 
           Description = 
             c("Minimum temperature for plasmodium development (MTT)", 
               "Degree days above MTT to complete plasmodium development"), 
           Value = c(attr(plasmod_devel_seq, "MTT"), 
                     attr(plasmod_devel_seq, "devel_degdays")))
plasmod_params_front$Type[-1] <- NA

plasmod_params_appendix <- 
  data.frame(Type = "Plasmodium parameters", 
           Description = 
             c("Number of days below minimum temperature for development that reset degree days"), 
           Value = c(attr(plasmod_devel_seq, "timeout")))

# temperature series

temp_seq <- attr(res, "temp_seq")

## modelled date ranges
daterange.run <- attr(res, "run.daterange")
daterange.run.fmt <- paste(daterange.run, collapse = " to ")

## burnin info
daterange.burnin <- attr(res, "burnin.range")
daterange.burnin.fmt <- paste(daterange.burnin, collapse = " to ")

burnin.reps <- attr(res, "burnin.reps")
burnin.reps.fmt <- paste(burnin.reps, "times")

## time series info
daterange.stored <- range(temp_seq$Date[temp_seq$source %in% "stored"])
daterange.stored <- c(min(c(daterange.burnin, daterange.run)),
                      max(daterange.stored))
daterange.stored.fmt <- paste(daterange.stored, collapse = " to ")

date.stored.retreived <- format(attr(mosqmod::saved_station_temps, "access.date"), "%Y-%m-%d")

daterange.projected <- range(temp_seq$Date[temp_seq$source %in% "projected"])
daterange.projected.fmt <- paste(daterange.projected, collapse = " to ")

daterange.caldegday <- attr(attr(plasmod_devel_seq, "cal_degday_means"), "start_end_dates")
daterange.caldegday.fmt <- paste(rev(daterange.caldegday), collapse = " to ")

lookback.caldegday <- attr(attr(plasmod_devel_seq, "cal_degday_means"), "lookback")
lookback.caldegday.fmt <- sub("\\-", "", lookback.caldegday)

## format temperature series table
temp_series <- 
  data.frame(Description = c("Modelled date range", 
                             "Model burn-in date range",
                             "Burn-in time series repeated",
                             "Stored temperature dates",
                             "Projected temperature dates",
                             "Calendar degree day dates",
                             "Date range for calendar degree day calculation",
                             "Stored temperature records retreived"), 
             Value = c(daterange.run.fmt, daterange.burnin.fmt, burnin.reps.fmt,
                       daterange.stored.fmt, daterange.projected.fmt, daterange.caldegday.fmt,
                       lookback.caldegday.fmt, date.stored.retreived))
temp_series$Type <- "Temperature time series"
# separate tables into front page and appendix
temp_series_front <- temp_series[c(1,5),]
temp_series_appendix <- temp_series[-c(1,5),]
temp_series_front$Type[-1] <- temp_series_appendix$Type[-1] <- NA
```

```{r render front table, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# knit front page table
knitr::kable(
  rbind(general_info, 
        mosq_params_front[c("Type", "Description", "Value")], 
        plasmod_params_front,
        temp_series_front), 
  row.names = FALSE, align = c("l", "l", "r"))
```

<!-- Here is a footnote reference,[^1] and another.[^longnote] -->

```{r render population plot, echo=FALSE, fig.align='center', fig.width=6, dpi=300, message=FALSE, warning=FALSE}

mosqmod::plot_popn(res, selectPopn = c("M"), include_temp = TRUE, 
                                plasmod_devel = plasmod_devel_seq, 
                   MTD = attr(res, "params")[["MTD"]], 
                   MTT = attr(plasmod_devel_seq, "MTT")) + ggplot2::theme(text = ggplot2::element_text(size = 10)) #, line = ggplot2::element_line(size = 5))
```

```{r render overlay plot, echo=FALSE, fig.align='center', fig.width=6, dpi=300, message=FALSE, warning=FALSE}

mosqmod::plot_popn_years(res, selectPopn = c("M")) + ggplot2::theme(text = ggplot2::element_text(size = 10))
                                                 
```

\newpage

### APPENDIX

#### Additional parameters

```{r appendix table, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# knit appendix table
knitr::kable(
  rbind(mosq_params_appendix[c("Type", "Description", "Value")], 
        plasmod_params_appendix,
        temp_series_appendix), 
  row.names = FALSE, align = c("l", "l", "r"))
```
